<html>
<head>
  <title>A-Frame Racer</title>
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
  
</head>

<body>
  <a-scene 
    physics="driver: ammo; debug: false;" 
    game-manager
  >
    <a-assets>
      <img id="track" src="https://cdn.glitch.global/c6b24147-1af2-4e7d-864c-b5805562d92c/track.png?v=1672620700057">
      <img id="grass" src="https://cdn.glitch.global/c6b24147-1af2-4e7d-864c-b5805562d92c/grass.jpg?v=1672620706037">
    </a-assets>

    <a-entity 
      id="car" 
      position="0 0.5 0"
      ammo-body="type: kinematic; emitCollisionEvents: true;"
      ammo-shape="type: box; halfExtents: 0.5 0.5 1;"
      simple-car-controls
    >
      <a-box position="0 0 -0.2" scale="1 0.5 2" color="#D92B2B"></a-box>
      <a-box position="0 0.5 0.3" scale="0.8 0.4 1" color="#333"></a-box>

      <a-camera position="0 1.6 0.5" look-controls-enabled="false">
        <a-entity cursor="rayOrigin: mouse;"></a-entity>
        <a-text id="ui-text" value="Loading..." position="-0.5 -0.5 -1.5" align="left" width="1.5"></a-text>
        <a-text id="ui-timer" value="Time: 0.00s" position="0.5 -0.5 -1.5" align="right" width="1.5"></a-text>
        <a-plane id="ui-reward" position="0 0 -1.2" width="0.8" height="0.5" color="#111" opacity="0.9" text="value: Reward!; align: center; width: 1.5; color: #FFF;" visible="false"></a-plane>
      </a-camera>
    </a-entity>

    <a-sky color="#87CEEB"></a-sky>
    <a-plane id="ground" ammo-body="type: static;" ammo-shape="type: box; halfExtents: 50 0.1 50;" rotation="-90 0 0" position="0 -0.1 0" width="100" height="100" material="src: #grass; repeat: 20 20;"></a-plane>

    
    <a-entity id="level-1" visible="true">
      <a-plane ammo-body="type: static;" ammo-shape="type: box; halfExtents: 5 0.1 15;" rotation="-90 0 0" position="0 0 10" width="10" height="30" material="src: #track; repeat: 2 6;"></a-plane>
      <a-box ammo-body="type: static;" ammo-shape="type: box;" position="-5 1 10" scale="1 2 30" color="#444"></a-box>
      <a-box ammo-body="type: static;" ammo-shape="type: box;" position="5 1 10" scale="1 2 30" color="#444"></a-box>
      <a-box id="finish-1" ammo-body="type: static; emitCollisionEvents: true;" ammo-shape="type: box;" position="0 0.5 24.5" scale="10 1 1" color="#40FF00" opacity="0.5"></a-box>
    </a-entity>

    
    <a-entity id="level-2" visible="false">
      <a-plane ammo-body="type: static;" ammo-shape="type: box; halfExtents: 5 0.1 15;" rotation="-90 0 0" position="0 0 45" width="10" height="30" material="src: #track; repeat: 2 6;"></a-plane>
      <a-plane ammo-body="type: static;" ammo-shape="type: box; halfExtents: 15 0.1 5;" rotation="-90 0 0" position="15 0 60" width="30" height="10" material="src: #track; repeat: 6 2;"></a-plane>
      <a-box ammo-body="type: static;" position="-5 1 45" scale="1 2 30" color="#444"></a-box>
      <a-box ammo-body="type: static;" position="5 1 55" scale="1 2 10" color="#444"></a-box>
      <a-box ammo-body="type: static;" position="15 1 65" scale="30 2 1" color="#444"></a-box>
      <a-box ammo-body="type: static;" position="30 1 60" scale="1 2 10" color="#444"></a-box>
      <a-box ammo-body="type: static;" position="10 1 30" scale="30 2 1" color="#444"></a-box>
      <a-box id="finish-2" ammo-body="type: static; emitCollisionEvents: true;" ammo-shape="type: box;" position="29 0.5 60" scale="1 1 10" color="#40FF00" opacity="0.5"></a-box>
    </a-entity>
    
  </a-scene>

  <script>
    // ---------------------------------------------------------------- //
    //  1. SIMPLE CAR CONTROLS COMPONENT
    // ---------------------------------------------------------------- //
    AFRAME.registerComponent('simple-car-controls', {
      schema: {
        speed: { type: 'number', default: 10 },
        rotationSpeed: { type: 'number', default: 30 },
      },

      init: function () {
        this.keys = {};
        this.linearVelocity = new THREE.Vector3();
        this.angularVelocity = new THREE.Vector3();
        this.body = null;

        window.addEventListener('keydown', (e) => (this.keys[e.code] = true));
        window.addEventListener('keyup', (e) => (this.keys[e.code] = false));
      },

      tick: function (time, delta) {
        if (!this.body) {
          this.body = this.el.components['ammo-body'];
          if (!this.body) return;
        }

        const el = this.el;
        const data = this.data;
        const body = this.body.body; 
        if (!body) return; 
        const dt = delta / 1000; 

        let forwardSpeed = 0;
        let turnSpeed = 0;

        if (this.keys['KeyW'] || this.keys['ArrowUp']) {
          forwardSpeed = -data.speed;
        }
        if (this.keys['KeyS'] || this.keys['ArrowDown']) {
          forwardSpeed = data.speed;
        }
        if (this.keys['KeyA'] || this.keys['ArrowLeft']) {
          turnSpeed = data.rotationSpeed;
        }
        if (this.keys['KeyD'] || this.keys['ArrowRight']) {
          // *** THIS IS THE FIXED LINE ***
          turnSpeed = -data.rotationSpeed; 
        }

        const rotation = el.object3D.rotation.clone();
        
        this.angularVelocity.set(0, THREE.MathUtils.degToRad(turnSpeed), 0);
        body.setAngularVelocity(
          new Ammo.btVector3(
            this.angularVelocity.x,
            this.angularVelocity.y,
            this.angularVelocity.z
          )
        );

        this.linearVelocity.set(0, 0, forwardSpeed);
        this.linearVelocity.applyEuler(rotation); 
        
        body.setLinearVelocity(
          new Ammo.btVector3(this.linearVelocity.x, 0, this.linearVelocity.z)
        );

        body.activate();
      },
    });

    // ---------------------------------------------------------------- //
    //  2. GAME MANAGER COMPONENT
    // ---------------------------------------------------------------- //
    AFRAME.registerComponent('game-manager', {
      init: function () {
        this.runGameSetup = this.runGameSetup.bind(this);

        if (this.el.sceneEl.hasLoaded) {
          this.runGameSetup();
        } else {
          this.el.sceneEl.addEventListener('loaded', this.runGameSetup);
        }
      },

      runGameSetup: function () {
        console.log('Scene loaded, running game setup!');
        this.carEl = document.getElementById('car');
        this.level1 = document.getElementById('level-1');
        this.level2 = document.getElementById('level-2');
        this.finish1 = document.getElementById('finish-1');
        this.finish2 = document.getElementById('finish-2');
        this.uiText = document.getElementById('ui-text');
        this.uiReward = document.getElementById('ui-reward');
        this.uiTimer = document.getElementById('ui-timer');

        this.startTime = 0;
        this.timerInterval = null;
        this.currentLevel = 0;

        this.onCollide = this.onCollide.bind(this);
        this.carEl.addEventListener('collidestart', this.onCollide);
        
        this.startGame();
      },

      startGame: function () {
        this.uiReward.setAttribute('visible', false);
        this.startLevel(1);
      },

      startLevel: function (level) {
        this.currentLevel = level;
        this.resetCarPosition(level);

        if (level === 1) {
          this.level1.setAttribute('visible', true);
          this.level2.setAttribute('visible', false);
        } else if (level === 2) {
          this.level1.setAttribute('visible', false);
          this.level2.setAttribute('visible', true);
        }

        this.uiText.setAttribute(
          'value',
          `Level ${level}\nGet to the green finish line!`
        );

        this.startTime = Date.now();
        if (this.timerInterval) clearInterval(this.timerInterval);

        this.timerInterval = setInterval(() => {
          const elapsed = ((Date.now() - this.startTime) / 1000).toFixed(2);
          this.uiTimer.setAttribute('value', `Time: ${elapsed}s`);
        }, 100);
      },

      onCollide: function (e) {
        if (!e.detail.body.el) return;
        const collidedWithId = e.detail.body.el.id;

        if (this.currentLevel === 1 && collidedWithId === 'finish-1') {
          this.finishLevel(1);
        } else if (this.currentLevel === 2 && collidedWithId === 'finish-2') {
          this.finishLevel(2);
        }
      },

      finishLevel: function (level) {
        clearInterval(this.timerInterval);
        const endTime = Date.now();
        const totalTime = ((endTime - this.startTime) / 1000).toFixed(2);

        let reward = 'No reward...';
        if (totalTime < 15) {
          reward = 'GOLD MEDAL! ⭐⭐⭐';
        } else if (totalTime < 25) {
          reward = 'Silver Medal! ⭐⭐';
        } else {
          reward = 'Bronze Medal! ⭐';
        }

        if (level === 1) {
          this.uiText.setAttribute('value', 'Level 1 Complete!');
          this.showReward(reward, totalTime, () => this.startLevel(2));
        } else if (level === 2) {
          this.uiText.setAttribute('value', 'Game Complete!');
          this.showReward(reward, totalTime, () => this.startGame());
        }
      },

      showReward: function (reward, time, nextAction) {
        this.uiReward.setAttribute('visible', true);
        this.uiReward.setAttribute(
          'value',
          `Time: ${time}s\n\n${reward}\n\nLoading next level...`
        );

        setTimeout(() => {
          this.uiReward.setAttribute('visible', false);
          nextAction();
        }, 5000);
      },

      resetCarPosition: function (level) {
        const carBody = this.carEl.components['ammo-body'];

        if (!carBody || !carBody.body) {
          console.warn('Car body not ready for reset. Retrying...');
          setTimeout(() => this.resetCarPosition(level), 100);
          return;
        }

        const body = carBody.body;
        const zeroVector = new Ammo.btVector3(0, 0, 0);
        const zeroQuat = new Ammo.btQuaternion(0, 0, 0, 1);

        let startPos = new Ammo.btVector3(0, 0.5, 0);
        if (level === 2) {
          startPos = new Ammo.btVector3(0, 0.5, 30);
        }

        let transform = body.getWorldTransform();
        transform.setOrigin(startPos);
        transform.setRotation(zeroQuat);
        body.setWorldTransform(transform);
        
        body.setLinearVelocity(zeroVector);
        body.setAngularVelocity(zeroVector);
      },
    });
  </script>
</body>
</html>